apiVersion: networking.istio.io/v1beta1
kind: VirtualService
metadata:
  annotations:
    sme.sap.com/resource-hash: "822c01ba45bd19a37ae3ca4d188aab8938cdc1fe886d3eab54208b2e61f09aa5"
    sme.sap.com/owner-identifier: default.test-cap-01-provider
  labels:
    sme.sap.com/owner-generation: "0"
    sme.sap.com/owner-identifier-hash: db1f1fd7eaeb0e6407c741b7e4b2540044bcc4ec
  name: test-cap-01-provider
  namespace: default
  ownerReferences:
    - apiVersion: sme.sap.com/v1alpha1
      blockOwnerDeletion: true
      controller: true
      kind: CAPTenant
      name: test-cap-01-provider
spec:
  gateways:
    - test-cap-01-gw
    - istio-system/cap-operator-domains-gen
  hosts:
    - my-provider.app-domain.test.local
    - my-provider.foo.bar.local
  http:
    - match:
      - headers:
          Cookie:
            regex: (^|.*; )COP_CAV=test-cap-01-cav-v1($|; .*)
        uri:
          regex: ^|.*(logout|logoff).*
      route:
      - destination:
          host: test-cap-01-cav-v1-app-router-svc.default.svc.cluster.local
          port:
            number: 5000
        headers:
          response:
            set:
              Set-Cookie: COP_CAV=test-cap-01-cav-v1;Path=/;HttpOnly;Secure;Max-Age=0
        weight: 100
    - match:
      - headers:
          Cookie:
            regex: (^|.*; )COP_CAV=test-cap-01-cav-v1($|; .*)
      route:
      - destination:
          host: test-cap-01-cav-v1-app-router-svc.default.svc.cluster.local
          port:
            number: 5000
        weight: 100
    - route:
      - destination:
          host: test-cap-01-cav-v1-app-router-svc.default.svc.cluster.local
          port:
            number: 5000
        headers:
          response:
            add:
              Set-Cookie: COP_CAV=test-cap-01-cav-v1;Path=/;HttpOnly;Secure;Max-Age=Session
        weight: 100